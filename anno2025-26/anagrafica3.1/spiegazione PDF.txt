ğŸ“˜ COME FUNZIONA LA FUNZIONE CHE CREA IL PDF â€” SPIEGAZIONE SEMPLICE (PER 17/18ENNI)

Questa funzione, riga dopo riga, costruisce un file PDF a mano, cioÃ¨ senza usare librerie come jsPDF.
Ãˆ interessante perchÃ© ti fa vedere come un PDF Ã¨ fatto davvero â€œdentroâ€.

Per capirla bene, dividiamo il funzionamento in 8 parti.

ğŸ”µ 1 â€” Raccolta dei dati del carrello

Allâ€™inizio la funzione prende i dati degli articoli dal carrello.
Quando li ha, li mette tutti in un array chiamato dati.

Se i dati sono un singolo oggetto, lo trasforma in un array con un solo elemento, cosÃ¬ il resto del codice puÃ² lavorare sempre nello stesso modo.

ğŸ”µ 2 â€” Preparazione delle righe da scrivere nel PDF

La funzione costruisce un elenco di stringhe (righe) che rappresentano il testo da mettere nel PDF:

Titolo â€œCARRELLO ACQUISTIâ€

Nomi delle colonne

Una riga di separazione

Una riga per ogni oggetto nel carrello

In pratica sta preparando il contenuto del PDF come se fosse una tabella di testo.

ğŸ”µ 3 â€” Creazione del contenuto testuale in formato PDF

Un PDF non usa testo normale, ma comandi speciali.
Per cominciare a scrivere testo, si usa BT (Begin Text).
Per scegliere il font: /F1 12 Tf.

Poi il codice prende ogni riga e crea dei comandi tipo:

Td â†’ sposta il cursore nella pagina

Tj â†’ scrive il testo

Viene gestito anche lâ€™â€œa capoâ€: ogni nuova riga viene spostata 15 punti sotto la precedente.

Ãˆ la parte che effettivamente genera il contenuto della pagina.

ğŸ”µ 4 â€” Creazione dei singoli oggetti PDF

Un PDF Ã¨ composto da tanti â€œoggetti numeratiâ€.
Qui vengono creati:

il Catalogo (oggetto principale del PDF)

lâ€™elenco delle pagine

la singola pagina

il contenuto testuale (lo stream con i comandi)

il font da usare

Ogni oggetto ha un formato come:

3 0 obj
<< ... contenuto ... >>
endobj


Questi oggetti vengono messi in un array.

ğŸ”µ 5 â€” Assemblaggio degli oggetti e calcolo degli offset

Quando inizia a costruire il PDF finale, la funzione aggiunge gli oggetti uno dopo lâ€™altro dentro una variabile pdf.

Ogni volta che aggiunge un oggetto registra lâ€™offset, cioÃ¨ la posizione in byte dove lâ€™oggetto parte.

Esempio:
se lâ€™oggetto 3 inizia al byte 240, allora il suo offset Ã¨ 240.

Questa informazione serve dopo, perchÃ© un PDF reader deve sapere esattamente dove andare a cercare ogni oggetto senza scorrere tutto il file.

ğŸ”µ 6 â€” Costruzione della tabella XREF

La tabella XREF Ã¨ lâ€™indice del PDF.
Dice al lettore:

â€œLâ€™oggetto 1 si trova qui, lâ€™oggetto 2 qui, lâ€™oggetto 3 quiâ€¦â€

Per ogni oggetto si scrive una riga con:

lâ€™offset (10 cifre)

il numero di generazione (quasi sempre 00000)

n = oggetto in uso

Il primo oggetto (0) Ã¨ sempre finto e contiene:

0000000000 65535 f


Se manca la tabella XREF, il PDF non puÃ² essere aperto.

ğŸ”µ 7 â€” Creazione del Trailer

Il trailer Ã¨ la parte finale che â€œchiudeâ€ il PDF.
Dice al lettore:

quanti oggetti ci sono (/Size)

qual Ã¨ lâ€™oggetto principale /Root (di solito 1 0 R)

dove si trova la tabella XREF (startxref)

che il file Ã¨ finito (%%EOF)

Ãˆ come la conclusione del documento, dove sono scritte le informazioni chiave per permettere ai programmi di leggere tutto correttamente.

ğŸ”µ 8 â€” Download del PDF

Alla fine viene creato:

un Blob (un oggetto che rappresenta il PDF)

un URL temporaneo

un finto click su un link per scaricare il PDF

Poi lâ€™URL viene cancellato dalla memoria.

Questo fa sÃ¬ che il PDF venga scaricato automaticamente dal browser con il nome:

carrello_acquisti.pdf